# ============================================================
# HAProxy Configuration for TAK Server (LXD Container Deployment)
# ============================================================
#
# This configuration is designed for the installTAK-LXD deployment
# using Option B networking: dedicated takbr0 bridge (10.100.100.0/24)
#
# Container IPs (from env.template):
#   TAK Server:    10.100.100.10
#   HAProxy:       10.100.100.11
#   MediaMTX:      10.100.100.12 (optional)
#   NextCloud:     10.100.100.13 (optional)
#   Node-RED:      10.100.100.14 (optional)
#
# USAGE:
#   1. Copy this file to your HAProxy container
#   2. Update [YOUR_DOMAIN] placeholders with your actual domain
#   3. Update [STATS_PASSWORD] with a secure password
#   4. Uncomment optional sections as needed
#
# PLACEHOLDER REMINDER:
#   Replace brackets AND text: [YOUR_DOMAIN] -> tak.example.com
#
# ============================================================

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Modern SSL configuration
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http


# ============================================================
# FRONTEND: HTTP (Port 80) - ACME Challenges & Redirects
# ============================================================
# Routes Let's Encrypt ACME challenges to appropriate backends
# Redirects all other HTTP traffic to HTTPS

frontend http-in
    bind *:80
    mode http

    # ACL for Let's Encrypt ACME challenges
    acl is_acme path_beg /.well-known/acme-challenge/

    # ACL for TAK domain (Let's Encrypt goes to TAK container)
    acl is_tak_domain hdr(host) -i [YOUR_DOMAIN]

    # Route ACME challenges for TAK domain to TAK container
    use_backend tak-acme-backend if is_acme is_tak_domain

    # OPTIONAL: Uncomment if using NextCloud
    # acl is_files_domain hdr(host) -i files.[YOUR_BASE_DOMAIN]
    # use_backend nextcloud-acme-backend if is_acme is_files_domain

    # Redirect everything else to HTTPS
    redirect scheme https code 301 if !is_acme


# ============================================================
# FRONTEND: TAK Client Connections (Port 8089)
# ============================================================
# CRITICAL: TAK uses mutual TLS (client certificates)
# HAProxy must use TCP passthrough - do NOT terminate SSL here

frontend tak-client
    bind *:8089
    mode tcp
    option tcplog

    # SSL hello check ensures we're getting SSL traffic
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    default_backend tak-client-backend


# ============================================================
# FRONTEND: TAK Web UI (Port 8443)
# ============================================================
# Also uses mutual TLS for certificate-based authentication

frontend tak-webui
    bind *:8443
    mode tcp
    option tcplog

    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    default_backend tak-webui-backend


# ============================================================
# FRONTEND: TAK Certificate Enrollment (Port 8446)
# ============================================================
# Uses Let's Encrypt certificate for browser trust
# Still TCP passthrough - TAK handles the TLS

frontend tak-enrollment
    bind *:8446
    mode tcp
    option tcplog

    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    default_backend tak-enrollment-backend


# ============================================================
# BACKEND: TAK ACME Challenges
# ============================================================
# Routes to nginx running in TAK container for Let's Encrypt

backend tak-acme-backend
    mode http
    server tak-acme 10.100.100.10:80 check


# ============================================================
# BACKEND: TAK Client Connections
# ============================================================

backend tak-client-backend
    mode tcp
    option tcp-check
    server tak-server 10.100.100.10:8089 check


# ============================================================
# BACKEND: TAK Web UI
# ============================================================

backend tak-webui-backend
    mode tcp
    option tcp-check
    server tak-server 10.100.100.10:8443 check


# ============================================================
# BACKEND: TAK Certificate Enrollment
# ============================================================

backend tak-enrollment-backend
    mode tcp
    option tcp-check
    server tak-server 10.100.100.10:8446 check


# ============================================================
# STATS: HAProxy Statistics Page
# ============================================================
# Access via SSH tunnel: ssh -L 8404:localhost:8404 user@vps
# Then browse to: http://localhost:8404/haproxy_stats

frontend stats
    bind 127.0.0.1:8404
    mode http
    stats enable
    stats uri /haproxy_stats
    stats refresh 10s
    stats admin if LOCALHOST
    stats auth admin:[STATS_PASSWORD]


# ============================================================
# OPTIONAL SERVICES
# ============================================================
# Uncomment sections below as needed

# ------------------------------------------------------------
# NextCloud (files.[YOUR_BASE_DOMAIN])
# ------------------------------------------------------------
# Uncomment if ENABLE_NEXTCLOUD="yes" in env.template

# frontend https-in
#     bind *:443 ssl crt /etc/haproxy/certs/
#     mode http
#
#     # ACL for NextCloud domain
#     acl is_files hdr(host) -i files.[YOUR_BASE_DOMAIN]
#
#     # Route to NextCloud backend
#     use_backend nextcloud-backend if is_files
#
# backend nextcloud-backend
#     mode http
#     option httpchk HEAD /status.php
#     http-check expect status 200
#     server nextcloud 10.100.100.13:80 check
#
# backend nextcloud-acme-backend
#     mode http
#     server nextcloud-acme 10.100.100.13:80 check


# ------------------------------------------------------------
# MediaMTX RTSP Video Streaming (Port 8554)
# ------------------------------------------------------------
# Uncomment if ENABLE_MEDIAMTX="yes" in env.template
#
# IMPORTANT: MediaMTX must be configured with protocols: [tcp]
# in mediamtx.yml. HAProxy cannot proxy UDP streams.
# See S1-MEDIAMTX-SETUP.md for configuration details.

# frontend rtsp-in
#     bind *:8554
#     mode tcp
#     option tcplog
#     default_backend mediamtx-backend
#
# backend mediamtx-backend
#     mode tcp
#     server mediamtx 10.100.100.12:8554 check


# ------------------------------------------------------------
# Node-RED Editor/UI (Port 1880)
# ------------------------------------------------------------
# Uncomment if ENABLE_NODERED="yes" in env.template
#
# SECURITY NOTE: Recommend SSH tunnel access instead of
# exposing Node-RED publicly. If you must expose it,
# ensure authentication is configured in Node-RED settings.js
# See S2-NODERED-SETUP.md for configuration details.

# frontend nodered-in
#     bind *:1880
#     mode http
#     option httplog
#     default_backend nodered-backend
#
# backend nodered-backend
#     mode http
#     server nodered 10.100.100.14:1880 check


# ============================================================
# END OF CONFIGURATION
# ============================================================
